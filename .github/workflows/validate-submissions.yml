name: Validate RDF Submissions

on:
  push:
    paths:
      - 'Submissions/**/*.ttl'
    branches:
      - main

jobs:
  validate-shacl:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install pySHACL
        run: pip install --upgrade git+https://github.com/RDFLib/pySHACL.git

      - name: Detect changed TTL file from commit message
        id: findfile
        run: |
          CHANGED=$(git log -1 --pretty=%B | grep -o 'Submissions/.*/graph_.*\.ttl' || echo "")
          echo "Changed file: $CHANGED"
          echo "changed_file=$CHANGED" >> $GITHUB_OUTPUT

      - name: Skip if file was deleted
        id: check_exists
        run: |
          FILE="${{ steps.findfile.outputs.changed_file }}"
          if [ -f "$FILE" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "File does not exist. Likely deleted. Skipping validation."
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Run SHACL validation
        if: steps.check_exists.outputs.exists == 'true'
        run: |
          changed_file="${{ steps.findfile.outputs.changed_file }}"
          shape_path="Submissions/shapes/$(basename $(dirname "$changed_file")).ttl"
          tmp_trig_file="${changed_file%.ttl}.trig"
          result_file="${changed_file/graph_/validation_}"
          result_file="${result_file%.ttl}.md"

          echo "Converting $changed_file to $tmp_trig_file..."
          cp "$changed_file" "$tmp_trig_file"

          echo "Running SHACL validation..."
          python -m pyshacl -s "$shape_path" -df auto -sf turtle -f human "$tmp_trig_file" > "$result_file"

          echo "result_file=$result_file" >> $GITHUB_ENV

      - name: Commit and push validation result (only if changed)
        if: env.result_file != ''
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add "$result_file"

          if git diff --cached --quiet; then
            echo "âœ… No changes to commit for $result_file."
          else
            echo "ğŸ” Committing $result_file"
            git commit -m "Update validation result for $result_file"
            git push
