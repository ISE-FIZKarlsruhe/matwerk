name: Validate RDF Submissions

on:
  push:
    paths:
      - 'Submissions/**/*.ttl'
    branches:
      - main

jobs:
  validate-shacl:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install pySHACL
        run: pip install --upgrade git+https://github.com/RDFLib/pySHACL.git

      - name: Detect changed TTL file from commit message
        id: findfile
        run: |
          CHANGED=$(git log -1 --pretty=%B | grep -o 'Submissions/.*/graph_.*\.ttl' || echo "")
          echo "Changed file: $CHANGED"
          echo "changed_file=$CHANGED" >> $GITHUB_OUTPUT


      - name: Run SHACL validation
        if: steps.findfile.outputs.changed_file != ''
        run: |
          changed_file="${{ steps.findfile.outputs.changed_file }}"
          
          # If the file is .ttl, switch to .trig for validation
          changed_file_trig="${changed_file%.ttl}.trig"
      
          # Use base folder name to select shape
          shape_path="Submissions/shapes/$(basename $(dirname "$changed_file")).ttl"
      
          # Define the output result file
          result_file="${changed_file_trig/graph_/validation_}"
          result_file="${result_file%.trig}.md"
      
          echo "Running SHACL validation on $changed_file_trig..."
          python -m pyshacl -s "$shape_path" -df auto -sf turtle -f human "$changed_file_trig" > "$result_file"
      
          echo "result_file=$result_file" >> $GITHUB_ENV

      - name: Commit and push validation result
        if: env.result_file != ''
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add "$result_file"
          git commit -m "Add validation result for RDF submission"
          git push
