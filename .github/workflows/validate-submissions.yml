name: Validate RDF Submissions

on:
  push:
    paths:
      - 'Submissions/**/*.ttl'
    branches:
      - main

jobs:
  validate-shacl:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install pySHACL
        run: pip install pyshacl

      - name: Detect changed TTL file
        id: findfile
        run: |
          CHANGED=$(git log -m -1 --name-only --pretty=format: | grep '^Submissions/.*/graph_.*\.ttl$' | head -n 1 || echo "")
          echo "Changed file: $CHANGED"
          echo "changed_file=$CHANGED" >> $GITHUB_OUTPUT

      - name: Run SHACL validation
        if: steps.findfile.outputs.changed_file != ''
        run: |
          changed_file="${{ steps.findfile.outputs.changed_file }}"
          shape_path="Submissions/shapes/$(basename $(dirname "$changed_file")).ttl"
          result_file="${changed_file/graph_/validation_}"
          result_file="${result_file%.ttl}.md"

          echo "Running SHACL validation on $changed_file..."
          python -m pyshacl -s "$shape_path" "$changed_file" > "$result_file"

          echo "result_file=$result_file" >> $GITHUB_ENV

      - name: Commit and push validation result
        if: env.result_file != ''
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add "$result_file"
          git commit -m "Add validation result for RDF submission"
          git push
